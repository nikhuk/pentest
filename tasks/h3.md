# H3 Attaaack!
Niko Hukkanen **23.4.2022**

Haaga-Helia ammattikorkeakoulu

Kurssi: [Tunkeutumistestaus](https://terokarvinen.com/2021/penetration-testing-course-2022-spring/)

Kurssin opettaja: [Tero Karvinen](https://terokarvinen.com/contact)

## Harjoituksessa käytetyt laitteet ja järjestelmät

 - Lenovon Legion Y540 kannettava tietokone (Intel i7-9750H CPU, RAM 16GB, Nvidia GTX 1660 Ti GPU, Host OS: Win 11 )
 - Oracle VM VirtualBox 6.1.32.
 - VM: Kali Linux ja Metasploitable 2

## x) Lue/katso/kuuntele ja tiivistä. Tässä alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen ja tiivistelmä riittää). Tiivistä ranskalaisilla viivoilla.

## € Percival & Samancioglu 2020: The Complete Ethical Hacking Course (video): [Chapter 21: Cross Site Scripting](https://learning.oreilly.com/videos/the-complete-ethical/9781839210495/9781839210495-video21_1) (7 videota, noin 25 min)

 -  Javascript injektion avulla ajetaan koodia kohteen verkkoselaimessa kahdella eri tavalla: Reflected XSS tai Stored XSS
 - Haavoittuvuuksien avulla mahdollisestataan Javascript injenktio.
 - Hyökkäys voidaan luoda kahdella tavalla: URL osoitteen sisällä, tai se voidaan tallentaa webpalvelimelle.
 - Kun urhrille saadaan ajettua haitallista Javascript koodia voidaan hänen selaimensa ottaa haltuun BeEF työkalulla, jonka avulla voidaan voidaan ajaa lisää haitallista koodia.
 - Yksi tapa välttää kyseinen hyökkäys on poistaa käytöstä javascript selaimesta, mutta tämä saattaa vaikuttaa ei vaarallisten sivustojen toimivuuteen.
 - Toinen tapa on käyttää sallittu/estetty listaa javascript koodin ajoon, jolloin voidaan lajitella sivustoja joilla käytetään Javascriptiä paremmin.

## [OWASP 10 2017 (pdf)](https://github.com/OWASP/Top10/raw/master/2017/OWASP%20Top%2010-2017%20(en).pdf) A2 Broken Authentication, A3 Sensitive Data Exposure, A7 Cross Site Scripting. (Poimi kustakin kolmesta hyökkäyksestä, miten ne käytännössä tehdään)

 **A2 Broken Authentication**
 - Hyökkäys voidaan toteuttaa murtamalla salasanalistoja automaattisesti, mikäli sovelluksessa ei ole mitään tätä estävää ominaisuutta.
 - Hyökkäys sovelluksen avoimiin istuntoihin ja niiden kaappaus.

**A3 Sensitive Data Exposure**
 - SQL injektion avulla voidaan hankkia dataa, vaikka ne olisivat salattu. Tietokannan salauksen voi murtaa SQL pyynnöllä, joka avaa salauksen.
 - Kaappaamalla liikennettä jota ei ole salattu.

**A7 Cross Site Scripting**
 - Hyökkäys voidaan tehdä Javascript injektion avulla, tällä tavalla voidaan kaapata weppi sivua käyttävän käyttäjän selain.
 - Koodia voidaan ajaa suoraan URL kautta (Reflected XSS) tai tallennettuna weppipalvelimelle (Stored XSS).

## MITRE 2021: [ATT&CK Enterprise Matrix](https://attack.mitre.org/matrices/enterprise). (Selitä tiivistelmässä käsitteet tactic, technique, procedure. Selitä kukin taktiikka (tactic) ja anna kustakin taktiikasta esimerkkitekniikka (technique tai subtechnique).

**Reconnaissance (Tiedustelu)**
 - Tiedustelussa pyritään selvittämään tietoja kohteesta tulevia hyökkäyksiä varten. Yksi esimerkki voisi olla aktiivinen verkkoskannaus, jossa skannataan kohteen verkkoa ja sen haavoittuvuuksia.

**Resource Development**
 
 - Hyökkääjä hankkii tarvittavat resurssit tulevan hyökkäyksen valmisteluksi, resursseja voi olla hyvin monenlaisia, joka riippuu hyökkäyksen tavasta. Yksi tapa hankkia tarvittavia resursseja on vuokrata laitteistoa tai muita hyökkäykselle olennaisia osia.

**Initial Access**

 - Hyökkääjän tavoitteena on saada pääsy hyökkäyksen kohteeseen. Pääsy voidaan saada aikaisemmin mainitulla Cross site scritping avulla.

**Execution**

 - Hyökkääjä pyrkii ajamaan haitallista koodia kohde koneella. Haitallista ohjelma koodia pyritään ajamaan komentorivillä, vaikka SSH-yhteyden yli.

**Persistence**
 - Hyökkääjä pyrkii pitämään yhteyden hyökättävään kohteeseen, vaikka kohde käynnistäisi laitteensa uudelleen tai tekisi muita muutoksia. Käyttäjätietoja manipuloimalla tai luomalla uuden käyttäjän voidaan pitää hyökkääjälle tarvittava yhteys muutoksista huolimatta.

**Privilege Escalation**
 - Ylempien käyttöoikeuksien saaminen hyökkääjälle, eli system tai root tason tunnukset. Hyökkääjä voi pyrkiä ajamaan ohjelman järjestelmän boot vaiheessa, jolla se saa system admin tai root tason oikeudet.
 
**Defense Evasion**

 - Hyökkääjä pyrkii välttämään hyökkäyksen havaitsemista. Hyökkäyksen tekijä pyrkii puolustuksen kiertämiseen eri tavoilla kuten: Hankkimalla ylemmät käyttöoikeudet, joilla voi tehdä enemmän muutoksia järjestelmän sisäisiin asetuksiin.

**Credential Access**

 - Hyökkääjä pyrkii varastamaan kohteen tunnuksia ja salasanoja. Yksi tapa toteuttaa tämä on käyttämällä brute force tapaa, jolla automaattisesti arvataan käyttäjän salasanoja.
 
 **Discovery**

 - Hyökkääjä pyrkii hankkimaan lisää hyökättävästä ympäristöstä ja siihen liittyvistä verkoista ja järjestelmistä. Yksi tapa toteuttaa tämä on etsimällä lisäätietoja käytetyistä käyttäjistä ja niiden ympäristöstä.

**Lateral Movement**

 - Hyökkääjä pyrkii liikkumaan ympäristössä kohteesta toiseen. Liikkumisessa voidaan käyttää hyväksi erilaisia etäpalveluita, kun yritetään liikkua kohteesta toiseen.
 
**Collection**

 - Hyökkääjä pyrkii löytämään ja kokoamaan tietoa, jota hän on alusta lähtien tavoitellut. Hyökkääjä voi asettua verkkolaitteiden väliin ja hankkia dataa tällä tavalla.
 
**Command and Control**

 - Hyökkääjä pyrkii kommunikoimaan kaapattujen järjestelmien kanssa ja hallitsemaan niitä. Hyökkääjä voi käyttää etähallintatyökaluja kaapattujen järjestelmien hallintaan, kuten esimerkiksi Team Viewer:iä tai muita etähallintatyökaluja.

**Exfiltration**

 - Hyökkääjä pyrkii varastamaan aikaisemmin keräämänsä tiedon. Hyökkääjä voi käyttää automaattisia työkaluja suodattamaan haluamiansa arkaluontoisia tiedostoja.

**Impact**

 - Hyökkääjä tuhoaa tai manipuloi kohdejärjestelmässä olevia tietoja. Hyökkääjä voi halutessaa tyhjentää kaikki levyillä olevat tiedot, mikäli hän niin haluaa.


## z) Cross site story. Kirjoita kuvitteellinen esimerkki XSS-hyökkäyksestä. Tee mahdollisimman yksinkertainen esimerkki. Voit vaikkapa ottaa haltuun weppisivun ylläpitäjän oikeudet viemällä keksin. Tässä alakohdassa ei tarvitse tehdä mitään tietokoneella, pelkkä tarina riittää. Tarkoituksena on ymmärtää XSS-hyökkäyksen kokonaisuus ennen sormiharjoituksia. Voi halutessasi myös piirtää itse kaavion / sarjakuvan.
Tee selväksi ja erottele

-   Mitä hyökkääjä tekee
-   Mitä kohdehenkilö tekee
-   Mitä sivua / palvelinta kohdehenkilö surffailee
-   Missä JavaScriptit ajetaan
-   Miten keksi päätyy hyökkääjälle
-   Miten hyökkääjä hyödyntää keksiä?
-   Mitä hyökkääjä pääsee tekemään (mikä ei onnistuisi ilman hyökkäystä)?

**Hyökkäyksen kuvaus:**
Kuvitteellinen esimerkkini olisi seuraavanlainen: Tunnettu verkkosivu, josta luodaan kopio mikä näyttää alkuperäiseltä, mutta sivusto on ylläpidetty toisessa kohteessa. Yksi tällainen sivusto voisi olla jonkin yrityksen kirjautumissivusto, johon työntekijät kirjautuvat saadakseen jonkinlaista dataa.

Tarkoituksena on saada hyökkäyksen kohde siirtymään haavoittuvalle sivustolle, joten sivuston URL tulisi olla mahdollisimman lähellä aitoa tunnettua verkkosivua. Joten hyökkäyssivustolle hankitaan mahdollisimman oikean näköinen nimi ja vuokrataan nimipalvelusta oikeanlainen domain.

Itse verkkosivulla olisi haavoittuvaa JavaScript koodia, joka ajetaan kohteen verkkoselaimessa. Haitallinen koodi sisältäisi BeEF koodia, jolla kohteen selain voitaisiin kaapata. BeEF työkalulla voidaan seurata täydellisesti käyttäjän tekemisiä selaimellaan.

Tekaistulle sivustolle voisi tehdä kirjautumissivuston, johonkin tunnettuun palveluun. Kohde kirjautuisi sivustolle, mutta hänen salasanansa ja tunnuksensa näkyisi BeEF työkalulla. Ensimmäisen kirjautumisen jälkeen kohde ohjattaisiin takaisin oikealle kirjautumissivulle.

Hyökkäyksen ansiosta hyökkäyksen tekijälle jää kohteen käyttäjätunnukset ja salasana haluamaansa palveluun. Hyökkääjä voi käyttää näitä varastaakseen "salaista" tietoa yritykseltä.

## a) Vuohen uudet seikkailut. Ratkaise WebGoatista tehtävät
Aloitin käynnistämällä webgoatin komennolla: `java -jar webgoat-server-8.0.0.M26.jar` ja siirryin osoiteeseen: `http://localhost:8080/WebGoat/login`
 Kun olin käynnistänyt Webgoatin siirryin tekemään ensinmäistä tehtävää. 

**A2 Broken authentication: Authentication bypasses: 2 2FA Password Reset**

  Kyseinen asia oli minulle täysin uutta, joten kävin kurkkaamassa tehtävässä annetun ohjeen ja esimerkki tapauksen sivustolta: [HenryHoggard](https://henryhoggard.co.uk/blog/Paypal-2FA-Bypass). 
Tehtävässä neuvottiin käyttämään selaimen kehittäjätyökalua ja seuramaan liikennettä. Löysin liikenteen seasta Verify account nimisen lähetteen
  ![webgoat1](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat1.png?raw=true)
    
Hiiren oikealla klikkauksella pystyin muokkaamaan post pyyntöä valitsemalla "Edit and Resend". 
![webgoat2](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat2.png?raw=true)

Muokkasin alkuperäistä pyyntöä palvelimelle lisäämällä siihen suuret numerot 91 ja 81, joita tuskin on käytössä salaisissa kysymyksissä.
Alkuperäinen pyyntö: `secQuestion0=tero&secQuestion1=katu&jsEnabled=1&verifyMethod=SEC_QUESTIONS&userId=12309746`
Muokattu pyyntö: `secQuestion90=tero&secQuestion81=katu&jsEnabled=1&verifyMethod=SEC_QUESTIONS&userId=12309746`


![webgoat3](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat3.png?raw=true)

Kun olin muokannut pyyntöä painoin sinistä "Send" ikonia. 
Tämän jälkeen sain vastaukseksi seuraavanlaisen syötteen selaimeen:

    {
      "lessonCompleted" : true,
      "feedback" : "Congrats, you have successfully verified the account without actually verifying it. You can now change your password!",
      "output" : null
    }

**A3 Sensitive data exposure: Insecure Login: 2 Let's try**

Seuraaava tehtävää varten ohjeissa pyydettiin käyttämään Wireshark liikenteen kaappaus ohjelmaa. 
Käynnistin wiresharkin kirjoittamalla komentorivlle: `wireshark`.  Liikenteen suodatukseen käytin ohjeesta löytynyttä tarkennusta `'http.request.method == POST`, joka rajaa liikenteen HTTP liikenteeseen ja POST pyyntöön. 

![webgoat4](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat4.png?raw=true)

Wiresharkin kaappauksen viimeiseltä riviltä löytyivät oikeat salasanat ilman minkäänlaista salausta.

    Line-based text data: text/plain (1 lines)
        {"username":"CaptainJack","password":"BlackPearl"}

Kirjautuminen yllämainituilla tunnuksilla onnistui, täten sain tehtävän suoritettua.

**A7 Cross Site Scripting (XSS): Cross site scripting**
**2 What is XSS?**

Tehtävässä avasin Firefoxin kehittäjä työkalun ja kirjoitin siellä consoleen seuraavanlaisen pätkän Javascriptiä:`alert.(document.cookie)`. Tämän jälkeen avasin myös toisen välilehden 

![webgoat5](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat5.png?raw=true)

Sain ilmoituksen (Alert), jossa kerrottiin (Cookie) eväste.

**7 Try It! Reflected XSS**

Kokeilin kirjoittaa Javascript koodia ensimmäiseen kohtaan jossas voi kirjoittaa tekstiä. Kohta oli seuraavan niminen:  **Enter your credit card number.** 
Ensimmäisellä kerrallla kirjoitin koodini väärin, joten se ei toiminut. Kirjoitin ensimmäisellä kerralla `alert("Moi Niko")`, joka ei toiminut.  Olin unohtanut kyseisestä kohdasta koodin alkuosan `<script>` ja loppuosan `</script>`. Lisättyäni nämä osat koodiini sain sen toimimaan.

    Enter your credit card number: <script>alert("Moi Niko") </script>

Kun painoin "Purchase" sain scriptini mukaisen alertin.
![webgoat6](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat6.png?raw=true)

Ilmoitus jonka olin luonut tuli läpi. Myös tehtävä ilmoitti onnistuneesta ostosta.


**A8:2013 Request Forgeries: Cross-Site Request Forgeries**
**3 "Basic Get CSRF Exercise"**
Tässä tehtävä osiosso koin suorittamisessa vaikeuksia, koska Cross-site request forgeries oli minulle entuudestaan tuntematon aihe. Katsoin seuraavat videot ennen tehtävien aloitusta  [Cross-Site Request Forgery (CSRF) Explained by 
PwnFunction](https://www.youtube.com/watch?v=eWEgUcHPle0) ja  [Cross Site Request Forgery by Computerphile](https://www.youtube.com/watch?v=vRBihr41JTo).

Videoiden jälkeen sain käsityksen siitä, mitä kyseisessä Webgoatin tehtävissä pitäisi tehdä. 

Jouduin myös käyttämään loppuvaiheessa apuna Evidence Monday kirjoittamaa [artikkelia](https://medium.com/@evidencemonday/webgoat-cross-site-request-forgery-solution-1c069985e80f).

Aloitin lipun kaappauksen luomalla uuden html sivuston, jonka tarkoituksena on "Submit Query" näppäintä painaessa ryöstää lippu.
![webgoat7](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat7.png?raw=true)

Luomani sivusto ja sen koodi:

    <form accept-charset="UNKNOWN" id="basic-csrf-get" method="POST" name="form1" target="_blank" successcallback="" action="http://localhost:8080/WebGoat/csrf/basic-get-flag">
    <input name="csrf" type="hidden" value="false">
    <input type="submit" name="submit">
</form>
Seuraava rivi lähettää pyynnön WebGoat palvelimelle.

    successcallback="" action="http://localhost:8080/WebGoat/csrf/basic-get-flag">

Lopulta testasin saamaani lipun arvoa ja se toimi oikein.

![webgoat8](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat8.png?raw=true)

**4 "Post a review on someone else’s behalf".**
Tehtävässä piti luoda oma samankaltainen lomake, kuin itse arvostelu sivulta löytyi.  Aloitin jälleen luomalla uuden HTML sivun tätä varten. 

Lomakkeeni koodi:

    <html>
        <form action="http://localhost:8080/WebGoat/csrf/review" method=post enctype='application/x-www>
                <input type="hidden" name="reviewText" type="text" value="Not good, and not me.">
                <input type="hidden" name="stars" type="text" value="2">
                <input type="hidden" name="validateReq" value="2aa14227b9a13d0bede0388a7fba9aa9">
                <input type="submit" value="Submit review">
        </form>
        </html>

Tämän jälkeen avasin selaimella uuden luomani `arvostelu.html` tiedoston. Avauksen jälkeen arvostelu sivustolle ilmestyi 3 uutta arvostelua omalta käyttäjältäni.

![webgoat9](https://github.com/nikhuk/pentest/blob/main/assets/h3/webgoat9.png?raw=true)

Nähtävästi arvostelu meni läpi kolme kertaa, vaikka avasin luomani tiedoston: `arvostelu.html` selaimeen vain kerran.

## b) Attakin alatekniikat. Demonstroi kaksi (2) alatekniikkaa (subtechnique) ATT&CK kehikosta. Tässä pitää siis käyttää näitä käytännössä johonkin harjoitusmaaliin. Voit käyttää haluamiasi valmiita työkaluja tai koodata / skriptata itse. Voit valita valmiin harjoitusmaalin tai tehdä sen itse. _Muista, että myös tiedustelussa pitää noudattaa lakia, etiikkaa, rajauksia (scope) ja hyviä tapoja._

**1  Tiedustelu: Aktiivinen tiedustelu**

Tässä alatekniikassa päätin käsitellä porttiskannausta osana aktiivista tiedustelua. Kohteena oli aikaisemmin asentamani Metasploitable 2 virtuaalikone, jonka portti skannaus tapahtui Kali virtuaalikoneelta. Koneet olivat samassa virtuaaliverkossa, eivätkä ne olleet yhteydessä internettiin. 
Porttiskannaus olisi myös mahdollista toteuttaa toisessa verkossa oleville kohteille, tai suoraan yhteen tiettyyn IP-osoitteeseen ja porttiin.
Seuraavalla komennolla suoritettiin verkon **192.168.180.1** skannaus komennolla:  `sudo nmap -sn 192.168.180.1-255`.

![nmap1](https://github.com/nikhuk/pentest/blob/main/assets/h3/nmap1.png?raw=true)

Verkosta löytyi Metasploitable 2 kone, jonka lähiverkon IP-osoite oli: **192.168.180.5**

Seuraavaksi siirryin porttiskannaamaan kyseistä Metasploitable 2 konetta komennolla: `sudo nmap -v 192.168.180.5`
![nmap2](https://github.com/nikhuk/pentest/blob/main/assets/h3/nmap2.png?raw=true)

Koneesta löytyi 33 avointa porttia ja 977 suljettua porttia, myös avointen porttien palveluiden nimet löytyivät skannauksen tuloksena. Hyökkääjä voisi tässä vaiheessa siirtyä etsimään haavoittuvuuksia erilaisista palveluista, jotka ovat käynnissä kohde koneella.


**2 Vaikutus: Järjestelmän vahingoittaminen.**

Hyökkääjä voi halutessaan tuhota tai vahingoittaa hyökkäyksenkohdetta. Mikäli hyökkääjä on saanut järjestelmään ylemmät oikeudet system/root, voi hän mielivaltaisesti poistaa tiedostoja ja käyttäjiä koneesta. On myös mahdollista reformatoida kaikki järjestelmiin liitetyt levyt, jolloin kaikki data katoaa levyiltä. 

Hyökkääjä voi käyttää myös valmiita haittaohjelmia järjestelmän tuhoamiseen. Hyökkääjä voi jättää kohdekoneelle kiristyshaittohjelman, mikäli hän haluaa vielä hyötyä hyökäyksen kohteesta. 

Esimerkkinä [MegaCortex](https://securityintelligence.com/posts/from-mega-to-giga-cross-version-comparison-of-top-megacortex-modifications/), jolla voidaan lukita koko käyttöjärjestelmä, myös kryptata kaikki tiedostot. Lukituksen ja käyttöjärjestelmän avausta vastaan voidaan vaatia lunnaita, jotka yleensä ovat kryptovaluutoita.



## Lähteet

 - https://terokarvinen.com/2021/penetration-testing-course-2022-spring/
 - https://learning.oreilly.com/videos/the-complete-ethical/9781839210495/9781839210495-video21_1
 - https://github.com/OWASP/Top10/raw/master/2017/OWASP%20Top%2010-2017%20(en).pdf
 - https://attack.mitre.org/matrices/enterprise
 - https://beefproject.com/
 - https://www.w3schools.com/html/html_forms.asp
 - https://medium.com/@evidencemonday/webgoat-cross-site-request-forgery-solution-1c069985e80f
 - https://www.youtube.com/watch?v=eWEgUcHPle0
 - https://www.youtube.com/watch?v=vRBihr41JTo
 - https://nmap.org/book/man.html
 - https://hackprogramming.com/how-to-crash-your-system-dangerous-linux-commands/
 - https://attack.mitre.org/software/S0576/
 - https://securityintelligence.com/posts/from-mega-to-giga-cross-version-comparison-of-top-megacortex-modifications/