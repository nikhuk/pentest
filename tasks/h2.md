# H2 turbo boosted
Niko Hukkanen **9.4.2022**

Haaga-Helia ammattikorkeakoulu

Kurssi: [Tunkeutumistestaus](https://terokarvinen.com/2021/penetration-testing-course-2022-spring/)

Kurssin opettaja: [Tero Karvinen](https://terokarvinen.com/contact)

## Harjoituksessa käytetyt laitteet ja järjestelmät

 - Lenovon Legion Y540 kannettava tietokone (Intel i7-9750H CPU, RAM 16GB, Nvidia GTX 1660 Ti GPU, Host OS: Win 11 )
 - Oracle VM VirtualBox 6.1.32.
 - VM: Kali Linux ja Metasploitable 2

## Lue ja tiivistä. Tässä z-alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen ja tiivistelmä riittää). Tiivistämiseen riittää muutama ranskalainen viiva.
 [OWASP 10 A03:2021 - Injection](https://owasp.org/Top10/A03_2021-Injection/)

 - Vuoden 2021 OWASP listassa Injektio on kolmantena uhkana.
 -  Syötteiden eristäminen on ja validointi on hyvä keino estää injektion tapahtumista
 -  Yleisesti hyökkäyksiä kohdennetaan erilaisiin tietokantoihin, tai lomakkeisiin.
 -  Haavoittuvuus voidaan välttää oikeanlaisilla konfiguroinnilla.
 -  Käyttämällä Suojattua API rajapintaa voidaan suojautua injektioilta.



## SELECT * FROM student. Ratkaise [SQLZoo:sta](https://sqlzoo.net/wiki/SQL_Tutorial): 0 SELECT basics, 1 SELECT name, 2 SELECT from World.
Harjoituksessa harjoitellaan SQL komentoja. Tein myös **SELECT name** kohdasta 10 harjoitusta lisäharjoitukseksi.

**Select basics** 
1.

![sql1](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql1.png?raw=true)

2.

![sql2](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql2.png?raw=true)

3
 
![sql3](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql3.png?raw=true)

**Select Names**

1.
![sql4](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql4.png?raw=true)

2. 

![sql5](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql5.png?raw=true)

3. 

![sql6](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql6.png?raw=true)

4.

![sql7](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql7.png?raw=true)

5.

![sql8](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql8.png?raw=true)

6.

![sql9](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql9.png?raw=true)

7.

![sql10](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql10.png?raw=true)

8.

![sql11](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql11.png?raw=true)

9.

![sql12](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql12.png?raw=true)

10.

![sql13](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql13.png?raw=true)

**Select from world**

1.

![sql14](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql14.png?raw=true)

2.

![sql15](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql15.png?raw=true)

3.

![sql16](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql16.png?raw=true)

4.

![sql17](https://github.com/nikhuk/pentest/blob/main/assets/h2/sql17.png?raw=true)


## Ratkaise WebGoatista: A1 Injection (intro).

1.
Käyttäjän haku etunimen perusteella (first_name).
Valinta paikasta department ja employees. Mistä valitaan first_name perusteella bob `SELECT department FROM employees WHERE first_name='Bob';`

![webgoat1](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat1.png?raw=true)

2. 
Päivitettään työntekijä Tobin department sale.

    UPDATE employees SET department='Sales' WHERE first_name='Tobi';

![webgoat2](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat2.png?raw=true)

3.
Alter funktiolla muokataan aikaisempaa taulua ja siihen lisätään uusi rivi puhelinnumeroille , joiden pituus voi olla 20 merkkiä.

    Alter TABLE employees ADD phone varchar(20);

![webgoat3](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat3.png?raw=true)

4.
Annetaan oikeus käyttäjälle **"UnauthorizedUser"** muokata taulua.

    GRANT ALTER TABLE to UnauthorizedUser


![webgoat4](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat4.png?raw=true)

5.
Injektio sai toimimaan kuvassa olevilla vaihtoehdoilla.

![webgoat5](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat5.png?raw=true)

6.
Injektio tapahtui **user_id:** rivillä.

    Login_Count: 1
    User_Id: 1 or 1=1; 	 	


![webgoat6](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat6.png?raw=true)

7.
Ensimmäisen rivin tekstillä ei ole merkitystä, toisella rivillä tapahtuu itse injektio, jolla hankitaan tiedot.

    ' or '1' = '1

![webgoat7](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat7.png?raw=true)

8.

Ensimmäiselle riville voi kirjoittaa mitä haluaa, koska muutokset tehdään toisella rivillä.
Toinen rivi jolla palkankorotus tapahtuu. UPDATE parametrillä päivitetään taulukkoa. SET säätää palkan korotuksen. Käyttäjä indentifioidaan AUTH_TAN koodilla (3SL99A), joka löytyi edellisessä tehtävässä. 

    '; UPDATE employees SET salary=9999999 WHERE auth_tan='3SL99A


![webgoat8](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat8.png?raw=true)

9.
Lopuksi poistetaan jäljet seuraavasti

    '; DROP TABLE access_log;--
   
   DROP TABLE poistaa olemassa olevan taulukon nimeltä: access_log.

![webgoat9](https://github.com/nikhuk/pentest/blob/main/assets/h2/webgoat9.png?raw=true)



## Nyrkkeilysäkki. Asenna Metasploitable 2 samaan verkkoon Kalin kanssa. Katso, ettei haavoittuva Metasploitable 2 näy Internetiin.

Löysin nyrkkeilysäkin seuraavalta sivustolta [Sourceforge](https://sourceforge.net/projects/metasploitable/files/Metasploitable2/).
Latasin zip tiedoston, joka sisälsi Metasploitable 2 haavoittuvan järjestelmän.
Ohjeena käytin Metasploitable dokumentaatiota, jonka löysin seuraavasta osoitteesta [Rapid7](https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide/).

Zip tiedoston sisältö löytyi virtuaalinen kovalevy, jonka liitin uuteen Metasploit 2 koneeseen.

Ennen käynnistämistä kävin poistamassa verkkoadapterin, jonka avulla kone olisi voinut olla yhteydessä verkkoon.
Loin uuden adapterin, jonka avulla Metasploitable 2 voi olla yhteydessä Kali virtuaalikoneeseen.

![meta2](https://github.com/nikhuk/pentest/blob/main/assets/h2/meta2.png?raw=true)

Tämän jälkeen käynnistin virtuaalikoneen Metasploitable 2. Kirjauduin sisään ja tarkistin onko koneessa verkkoyhteyttä.

![meta1](https://github.com/nikhuk/pentest/blob/main/assets/h2/meta1.png?raw=true)

Selvisi se että kone ei ole yhteydessä internettiin.



## Nauhalle. Nauhoita kaikki konsolissa annetut asiat ja näkyvät tulosteet koko tehtävästä. (esim script)
Nauhoittaminen tapahtui seuraavalla komennolla: `script -fa h2niko`.

![nauha](https://github.com/nikhuk/pentest/blob/main/assets/h2/nauha.png?raw=true)

Kyseisellä scriptillä voidaan tallentaa tulosteet.

## Ei kuulu! Ennenkuin aloitat skannaukset, kokeile, ettei Kali pääse nettiin 'ping 8.8.8.8' vastaa "Network is unreachable".
Kävin laittamassa adapterin pois päältä, jonka avulla Kali virtuaalikoneeni on yhteydessä Internettiin. Tämän jälkeen käynnistin virtuaalikoneeni ja kokeilin komennolla `ping 8.8.8.8`. Olisiko yhteys poikki Internettiin.

![eikuulu](https://github.com/nikhuk/pentest/blob/main/assets/h2/eikuulu.png?raw=true)

Kone ei ole enään yhteydessä Internettiin.

## Piilosilla. Etsi Metasploitable 2 verkkoskannauksella. Tarkista ensin, että osoitteet ovat uskottavia (ipcalc 10.0.0.1/23). Sitten ping sweep (nmap -sn). Analysoi tulokset, eli selitä, mitä mikäkin asia tulosteessa tarkoittaa. Mitä päättelet eri koneista?

Tässä vaiheessa koin ongelman Kali virtuaalikoneen ja Metasploitable 2 koneen välillä, koneet eivät pystyneet kommunikoimaan keskenään. Ongelman ratkaisuksi asensin uudelleen VMBoxin Host-Adapterin, joka hoitaa koneiden välisiä yhteyksiä. Uudelleen asennuksen jälkeen koneet pystyivät kommunikoimaan, testasin sen ping komennon avulla.

![vmtovm](https://github.com/nikhuk/pentest/blob/main/assets/h2/vmtovm.png?raw=true)

Kun olin varmistanut yhteyden koneiden välillä ajoin verkkoskannauksen nmapilla komennolla:  `sudo nmap -sn 192.168.180.1-255`.


![nmap1](https://github.com/nikhuk/pentest/blob/main/assets/h2/nmap1.png?raw=true)

Skannauksen tuloksena löytyi 4 hostia ja niiden MAC osoitteet. Osoitteiden perusteella Metasploitable 2 koneen löytyvän viimeiseltä riviltä tiedoin :
 `MAC Address: 08:00:27:12:01:3A (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.180.4
`.


## Kilo. Porttiskannaa 1000 tavallisinta porttia löydetyistä koneista. Selitä ja analysoi tulokset. Mikä koneista voisi olla Metasploitable 2?
Porttiskannaus tapahtui komennolla: `sudo nmap -v 192.168.180.1-6 -oA portscanh2
`.  Rajasin skannauksen aluetta pienemmäksi, koska aikaisemmassa tehtävässä selvisi, että saatavilla olevat koneet ovat 192.168.180.1-192.168.180.6 IP-osoitteiden välillä. Viimeinen osa -oA portscan tallentaa skannauksen tuloksen tiedostoon portscanh2.

    Nmap scan report for 192.168.180.5
    Host is up (0.00024s latency).
    Not shown: 977 closed tcp ports (reset)
    PORT     STATE SERVICE
    21/tcp   open  ftp
    22/tcp   open  ssh
    23/tcp   open  telnet
    25/tcp   open  smtp
    53/tcp   open  domain
    80/tcp   open  http
    111/tcp  open  rpcbind
    139/tcp  open  netbios-ssn
    445/tcp  open  microsoft-ds
    512/tcp  open  exec
    513/tcp  open  login
    514/tcp  open  shell
    1099/tcp open  rmiregistry
    1524/tcp open  ingreslock
    2049/tcp open  nfs
    2121/tcp open  ccproxy-ftp
    3306/tcp open  mysql
    5432/tcp open  postgresql
    5900/tcp open  vnc
    6000/tcp open  X11
    6667/tcp open  irc
    8009/tcp open  ajp13
    8180/tcp open  unknown
    MAC Address: 08:00:27:12:01:3A (Oracle VirtualBox virtual NIC)

Aikaisempaan tehtävään perustuen identifioin tämän tuloksen Metasploitable 2 koneeksi MAC osoitteen ja IP osoitteen perusteella.  Porttiskannauksen tuloksena ei löytynyt muita avoimia portteja muista koneista. Myöskään samassa verkossa toimivassa Kali virtuaalikoneessa ei ole asennettuna, tai käytössä ohjelmia joita porttiskannauksessa löytyi.

## Ja tiskiallas. Porttiskannaa Metasploitable 2 perusteellisesti. Selitä ja analysoi tulokset. Selitä kustakin avoimesta portista, mikä palvelu siinä on / mihin se on tarkoitettu, onko se tavallisesti näkyvissä Internetiin ja onko se nykyiaikainen. Voit myös arvioida, onko versio päivitetty.

Metasploitable 2 koneen MAC osoite ja IP-osoite selvisivät viimeisessä harjoituksessa, joten nyt voidaan kohdentaa tarkempi skannaus tähän kohteeseen komennolla: `sudo nmap -sV 192.168.180.5 -oA metasploitable2`. Samalla tallennetaan tiedot tiedostoon metasploitable2. `-sV` kertoo avoimista porteista, sekä niissä olevien ohjelmien versioista.

    Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-06 20:48 EEST
    Nmap scan report for 192.168.180.5
    Host is up (0.000083s latency).
    Not shown: 977 closed tcp ports (reset)
    PORT     STATE SERVICE     VERSION
    21/tcp   open  ftp         vsftpd 2.3.4
    22/tcp   open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
    23/tcp   open  telnet      Linux telnetd
    25/tcp   open  smtp        Postfix smtpd
    53/tcp   open  domain      ISC BIND 9.4.2
    80/tcp   open  http        Apache httpd 2.2.8 ((Ubuntu) DAV/2)
    111/tcp  open  rpcbind     2 (RPC #100000)
    139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
    445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
    512/tcp  open  exec        netkit-rsh rexecd
    513/tcp  open  login       OpenBSD or Solaris rlogind
    514/tcp  open  shell       Netkit rshd
    1099/tcp open  java-rmi    GNU Classpath grmiregistry
    1524/tcp open  bindshell   Metasploitable root shell
    2049/tcp open  nfs         2-4 (RPC #100003)
    2121/tcp open  ftp         ProFTPD 1.3.1
    3306/tcp open  mysql       MySQL 5.0.51a-3ubuntu5
    5432/tcp open  postgresql  PostgreSQL DB 8.3.0 - 8.3.7
    5900/tcp open  vnc         VNC (protocol 3.3)
    6000/tcp open  X11         (access denied)
    6667/tcp open  irc         UnrealIRCd
    8009/tcp open  ajp13       Apache Jserv (Protocol v1.3)
    8180/tcp open  http        Apache Tomcat/Coyote JSP engine 1.1
    MAC Address: 08:00:27:12:01:3A (Oracle VirtualBox virtual NIC)
    Service Info: Hosts:  metasploitable.localdomain, irc.Metasploitable.LAN; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
    
    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 25.02 seconds

Metasploitable 2 koneesta löytyi useita avoimia portteja yhteensä 23.

 - 22/tcp OpenSSH 4.7p1 Käytetään etäyhteyden muodostamiseen. Tästä ohjelmasta on uusin versio saatavilla on 8.9/8.9p1.
 - 23/tcp Portissa on etäyhteyden ottoon tarkoitettu Telnet. Nykyään Telnetin käyttöä ei suositella, koska siinä tapahtuva liikenne on salaamatonta. Omasta mielestäni tämä on vanhanaikainen etätyökalu. 
 - 80/tcp Apache httpd 2.2.8 weppipalvelin. Tästä löytyy uudempi versio 2.4.53.
 - 5432/tcp  PostgreSQL DB 8.3.0 - 8.3.7. Tietokanta ohjelma. Tästä löytyy uusi versio 14.2.
 - 3306/tcp  MySQL 5.0.51a Tietokanta ohjelma. Tästä löytyy uusi versio 8.0.28.
 - 2121/tcp ProFTPD 1.3.1 FTP-Palvelin. Tästä löytyy uusi versio 1.3.8.

Koneesta löytyvät ohjelmat ovat suurimmalta osin vanhentuneita. Tämä mahdolistaa erilaisten haavoittuvuuksien hyväksikäytön konetta vastaan.


## Ovi jäi auki. Mitä löytyy portista 1524/tcp? Kokeile netcattilla 'nc'.
Komennolla `nc 192.168.180.5 1524`. Pääsin sisään "root" käyttäjänä Metasploitable 2 koneelle, 

![netcat](https://github.com/nikhuk/pentest/blob/main/assets/h2/netcat.png?raw=true)

asd

## Darn Low Security. Etsi Metasploitable 2 weppipalvelin. Tee paikallinen tunnus DVWA Damn Vulnerable Web App -ohjelmaan. Aseta vasemman reunan palkista "DVWA Security" Low.
Tarkistin löytyisikö kyseistä weppipalvelinta Metasploitablen omalla IP-osoitteella: **192.168.180.5**,

![webpage](https://github.com/nikhuk/pentest/blob/main/assets/h2/webpage.png?raw=true)

Linkki DVWA applikaatioon löytyi kyseiltä weppipalvelimelta.

![webpage2](https://github.com/nikhuk/pentest/blob/main/assets/h2/webpage2.png?raw=true)

Sivuston alalaidasta löytyi kirjautumis tunnukset: **admin/password**.

![dvwa](https://github.com/nikhuk/pentest/blob/main/assets/h2/dvwa.png?raw=true)

Script Security taso säädetty tasoon **"low"**.

## Execute! Ratkaise DVWA "Command Excution". ("DVWA Security" on paras olla "Low")

Sain ratkaistua kyseisen kohdan helposti lisäämällä merkin `";"` jonka avulla voidaan ajaa useampia komentoja Linux käyttöjärjestelmissä. Lähdekoodissa PHP avulla ajetaan ping komento ja lisäämällä `;` merkin syötekenttään voidaan ajaa useampia komentoja ping komennon yhteydessä. Eli tässä tapauksessa ajetaan vain `cat /etc/passwd` ja `hostname` komennot.

![enter image description here](https://raw.githubusercontent.com/nikhuk/pentest/85648e54c1131bb4c097031b22cf6e7487845e7c/assets/h2/dvwa2.png)

## Lähteet

 - https://terokarvinen.com/2021/penetration-testing-course-2022-spring/
 - https://owasp.org/Top10/A03_2021-Injection/
 - https://www.sqltutorial.org/sql-cheat-sheet/
 - https://learnsql.com/blog/sql-basics-cheat-sheet/
 - https://www.invicti.com/blog/web-security/sql-injection-cheat-sheet/
 - https://www.w3schools.com/sql/sql_injection.asp
 - https://stackoverflow.com/questions/332365/how-does-the-sql-injection-from-the-bobby-tables-xkcd-comic-work
 - https://sourceforge.net/projects/metasploitable/files/Metasploitable2/
 - https://community.rapid7.com/docs/DOC-1875
 - https://terokarvinen.com/oldsite/otherauthors/ubuntu-kickstart-karjalainen-2005/myy.helia.fi/_a0300187/linux/nmap.html?fromSearch=nmap
 - https://nmap.org/book/port-scanning-tutorial.html
 - https://httpd.apache.org/
 - https://www.postgresql.org/support/versioning/
 - https://www.mysql.com/
 - https://www.openssh.com/releasenotes.html
 - https://www.varonis.com/blog/netcat-commands
 - https://dvwa.co.uk/
 - https://www.linuxshelltips.com/run-multiple-linux-commands/
